# API Key 管理前端使用指南

本文档介绍如何在 YDMS 前端界面中管理 API Keys。

## 访问入口

### 权限要求
- **仅超级管理员（super_admin）** 可以访问 API Key 管理功能
- 课程管理员和校对员无法看到此菜单

### 打开方式
1. 登录 YDMS 系统
2. 点击右上角用户头像
3. 在下拉菜单中选择 **"API Key 管理"**
4. 右侧打开 API Key 管理抽屉

## 功能介绍

### 1. 统计卡片

在页面顶部显示 4 个统计卡片：

- **总计**：所有 API Keys 的总数（不含已删除）
- **活跃**：当前可用的 API Keys 数量
- **已过期**：超过过期时间的 API Keys 数量
- **已撤销**：被软删除的 API Keys 数量

### 2. 创建 API Key

#### 步骤

1. 点击 **"创建 API Key"** 按钮
2. 填写创建表单：
   - **名称**：描述性名称，方便识别用途（例如：批量导入工具）
   - **关联用户**：选择要关联的用户，API Key 将继承该用户的角色和权限
   - **环境**：选择 dev/test/prod，影响密钥前缀
   - **过期时间**：可选，留空表示永不过期
3. 点击 **"创建"** 按钮

#### 创建成功后

**重要提示**：完整的 API Key 仅显示一次！

- 系统会弹出新窗口显示完整的 API Key
- 格式：`ydms_<environment>_<random-base64>`
- 提供 **"复制 API Key"** 按钮快速复制
- **关闭窗口后将无法再次查看完整密钥**
- 请立即保存到安全的地方

### 3. API Key 列表

列表显示所有 API Keys，包含以下信息：

| 列名 | 说明 |
|------|------|
| **名称** | API Key 的描述性名称 |
| **密钥前缀** | 显示格式：`ydms_prod_abc123...`（仅前缀） |
| **状态** | 活跃（绿色）/ 已过期（红色）/ 已撤销（灰色） |
| **关联用户** | 用户名和角色 |
| **过期时间** | 相对时间显示（如"3天后"），鼠标悬停显示完整时间 |
| **最后使用** | 相对时间显示（如"2小时前"），鼠标悬停显示完整时间 |
| **创建时间** | 相对时间显示 |
| **操作** | 编辑、撤销、删除按钮 |

### 4. 编辑 API Key

1. 点击列表中的 **"编辑"** 按钮
2. 在弹窗中修改名称
3. 点击 **"保存"** 确认

**注意**：只能修改名称，无法修改其他属性。

### 5. 撤销 API Key

撤销后 API Key 将立即失效，无法再用于 API 认证。

1. 点击 **"撤销"** 按钮
2. 确认操作
3. API Key 状态变为 **"已撤销"**

**特点**：
- 软删除，保留记录
- 立即失效，无法恢复使用
- 仍然显示在列表中，但无法编辑

### 6. 永久删除 API Key

**仅超级管理员** 可以永久删除 API Key。

1. 点击 **"删除"** 按钮
2. 确认操作
3. API Key 从数据库中彻底删除

**警告**：删除后无法恢复！

### 7. 刷新数据

点击 **"刷新"** 按钮可以重新加载最新的 API Key 列表和统计数据。

## 使用场景

### 场景 1：为批量导入工具创建 API Key

1. 先创建一个课程管理员账号（在"用户管理"中）
2. 为该账号授予相应的课程权限
3. 在 API Key 管理中创建新的 API Key
   - 名称：`批量导入工具 - 2024春季学期`
   - 关联用户：选择刚创建的课程管理员
   - 环境：prod
   - 过期时间：设置为学期结束日期
4. 复制生成的 API Key
5. 在批量导入脚本中配置此 API Key

### 场景 2：临时测试 API

1. 创建测试用 API Key
   - 名称：`临时测试 - 开发环境`
   - 关联用户：测试账号
   - 环境：dev
   - 过期时间：1 天后
2. 使用此 API Key 进行测试
3. 测试完成后，撤销该 API Key

### 场景 3：轮换过期的 API Key

1. 查看列表，找到即将过期的 API Key
2. 创建新的 API Key 替代旧的
3. 更新外部程序配置，使用新的 API Key
4. 验证新 API Key 工作正常后，撤销旧的 API Key

## UI 特性

### 状态标签

- **活跃**（绿色标签）：API Key 可正常使用
- **已过期**（红色标签）：超过过期时间，无法使用
- **已撤销**（灰色标签）：已被软删除，无法使用

### 时间显示

- 默认显示相对时间（如"3天前"、"2小时后"）
- 鼠标悬停显示完整时间戳
- 使用中文本地化

### 操作权限

| 操作 | 超级管理员 | 其他角色 |
|------|-----------|---------|
| 查看列表 | ✅ | ❌ |
| 创建 API Key | ✅ | ❌ |
| 编辑名称 | ✅ | ❌ |
| 撤销 | ✅ | ❌ |
| 永久删除 | ✅ | ❌ |

### 响应式设计

- 表格支持横向滚动
- 自动分页（每页 10 条，可调整）
- 支持大屏幕显示更多列

## 安全提示

1. **完整密钥仅显示一次**
   - 创建后立即复制并保存到安全的地方
   - 关闭窗口后无法再次查看
   - 如果遗失，只能撤销后重新创建

2. **定期轮换密钥**
   - 建议为长期使用的 API Key 设置过期时间
   - 定期创建新密钥替换旧密钥
   - 及时撤销不再使用的密钥

3. **最小权限原则**
   - 为 API Key 关联最低权限的用户账号
   - 不要为临时测试创建超级管理员级别的 API Key
   - 为不同用途创建不同的 API Key

4. **监控使用情况**
   - 定期查看 "最后使用" 时间
   - 发现异常使用立即撤销
   - 保持统计数据准确

## 故障排查

### API Key 无法使用

检查项：
1. API Key 是否已撤销？（查看状态标签）
2. API Key 是否已过期？（查看过期时间）
3. 关联用户是否被删除？
4. 关联用户的权限是否足够？

### 创建失败

可能原因：
1. 未选择关联用户
2. 名称格式不正确（长度限制）
3. 网络问题或后端服务异常

### 列表不显示

可能原因：
1. 当前用户不是超级管理员
2. 后端服务未启动
3. API 端点配置错误

## 技术细节

### API 端点

前端通过以下 API 端点与后端通信：

- `GET /api/v1/api-keys` - 获取列表
- `POST /api/v1/api-keys` - 创建
- `GET /api/v1/api-keys/:id` - 获取详情
- `PATCH /api/v1/api-keys/:id` - 更新
- `POST /api/v1/api-keys/:id/revoke` - 撤销
- `DELETE /api/v1/api-keys/:id` - 删除
- `GET /api/v1/api-keys/stats` - 统计信息

### 数据刷新

- 创建/更新/删除操作后自动刷新列表
- 使用 TanStack Query 进行数据缓存和状态管理
- 支持手动刷新按钮

### 组件架构

```
APIKeyManagementDrawer (主容器)
  ├── APIKeyStatsCards (统计卡片)
  ├── APIKeyTable (列表表格)
  └── APIKeyCreateModal (创建弹窗)
```

## 相关文档

- [API Key 使用指南（后端）](./API_KEY_GUIDE.md) - 命令行和 Python 使用
- [API Key 实现总结](./API_KEY_IMPLEMENTATION_SUMMARY.md) - 技术实现细节
- [CLAUDE.md](../CLAUDE.md) - 项目文档

## 反馈和支持

如遇到问题或有改进建议，请联系开发团队或在项目仓库提交 Issue。
