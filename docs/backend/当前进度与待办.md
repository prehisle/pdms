# 当前进度与待办

## 当前进度
- [x] 迭代零：完成后端/前端骨架搭建，提交 `58f4061`。
- [x] 后端引入 `air` 自动重载配置并新增请求日志（提交 `705789b`），默认监听端口修改为 `9180`。
- [x] 后端：新增分类 API 层 `httptest` 用例，覆盖创建/树查询/排序/回收站/恢复/彻底删除及常见异常流程，内存 fake NDR 支撑后续扩展。
- [x] 后端：目录树查询支持分页聚合，节点数量超出单页时依然返回完整树结构。
- [x] 后端：回收站列表分页聚合，确保大量软删除节点时依然完整返回并通过单元测试验证。
- [x] 后端：新增目录节点 `reposition` 接口，支持一次请求完成跨父节点移动与同级重排。
- [x] 后端：支持 `YDMS_DEBUG_TRAFFIC` 日志开关，输出 NDR 请求/响应辅助排查。
- [x] 后端：禁止删除包含子节点的目录，提供批量恢复/彻底删除结合的回收站操作。
- [x] 后端：`go run ./cmd/server --watch` 支持内置热重载，免去手动重启。
- [x] 后端：接入 NDR 文档接口（列表/创建/绑定），新增节点文档获取与绑定能力。
- [x] 后端：文档列表及子树文档支持 `id` 查询参数筛选，兼容 NDR 分页响应结构。
- [x] 前端：安装测试依赖（vitest, @testing-library/react），修复 TypeScript 编译错误。
- [x] 后端/前端：批量删除前校验接口与预览弹窗完整实现。
- [x] 后端：批量操作（复制/移动）回滚策略实现，保障数据一致性。
- [x] **重大重构**：统一"资料"与"文档"概念，精简架构
  - 删除独立的 materials.go (396行) 和 relationships.go (135行)
  - 删除 Materials/Relationships API handlers (168行)
  - 删除前端 materials 模块 (~1000行)
  - 创建新的文档类型系统：overview、dictation、comprehensive_choice、security_analysis、essay
  - 定义内容格式：`{"format": "html/yaml", "data": "..."}`
  - 实现完整的类型和内容验证机制
  - 净减少代码 ~1500行，架构更清晰统一
- [x] 后端：文档版本管理完整实现，透传 NDR 版本接口（历史、对比、回滚）。


## 迭代一（目录管理）✅ 已完成
- [x] 后端：实现目录节点的 CRUD、树查询、拖拽移动接口并对接 NDR。
  - [x] 扩展 NDR Client 支持节点增删改查、子节点查询等接口。
  - [x] 暴露 `/api/v1/categories` 系列接口（含 `tree`、`move`、`reorder`），完善请求头透传与错误处理。
  - [x] 编写拖拽移动/排序逻辑及相关单元测试，覆盖 reorder 场景。
  - [x] 清理依赖记录，执行 `go mod tidy`。
  - [x] 新增 NDR 客户端集成测试与目录操作日志，便于排查真实环境问题。
  - [x] 目录软删除：后端新增回收站接口、日志与操作记录，并支持永久删除；默认由中间件填充 `x-user-id`、`x-request-id`。
  - [x] 永久删除：通过 `YDMS_ADMIN_KEY` 自动补齐 `x-admin-key` 请求头，接入 NDR purge 接口。
  - [x] 启动时输出 NDR 配置摘要，辅助排查 `.env` 是否生效。
- [x] 前端：完成目录树展示、节点 CRUD 表单、拖拽交互与接口联调。
  - [x] 接入目录树查询，基于 Antd Tree 展示结构并完成拖拽排序写回。
  - [x] 支持目录的新增、重命名、删除操作与详情面板，联动后端接口。
  - [x] 优化表单校验、操作状态反馈，并新增目录树搜索/展开能力。
  - [x] 拖拽排序改用 `reposition` 接口，避免二次请求及 NDR 404，新增前端校验与 `VITE_DEBUG_DRAG` 调试日志。
  - [x] 回收站批量恢复/彻底删除操作上线；目录树支持同父节点多选、高亮显示并校验跨层选择。
  - [x] 右键菜单：实现复制 / 剪切 / 粘贴 / 删除等批量操作。
  - [x] 软删除可视化：回收站视图、已删节点标记、恢复与彻底删除操作。
  - [x] 目录操作按钮图标化，回收站改为弹窗入口以释放主视图空间。
  - [x] 目录节点右键新增文档、文档区支持搜索与子树/当前节点切换。
- [x] 目录批量操作优化：
  - [x] 批量复制接口 `/api/v1/categories/bulk/copy`。
  - [x] 批量剪切/粘贴编排接口 `/api/v1/categories/bulk/move`。
  - [x] 批量操作回滚策略（复制失败删除已创建节点、移动失败恢复原位置）。
  - [x] 批量删除前校验接口 `/api/v1/categories/bulk/check`。
  - [x] 前端删除预览弹窗（显示关联文档、子节点等风险信息）。
  - [x] 剪贴板状态与批量粘贴 UI。
  - [x] 单节点删除前风险确认弹窗。

## 迭代二（资料管理扩展）⏳ 进行中
- [x] 后端：资料 CRUD 接口（题目、概览页、默写题等多类型支持）
  - [x] 资料类型系统：question（题目）、overview（概览）、dictation（默写）、reference（参考资料）
  - [x] 题目类型支持：single_choice、multi_choice、multi_blank_choice、fill_blank、essay
  - [x] 元数据验证：题目类型特定字段校验（选项、空格、答案等）
  - [x] `/api/v1/materials` 系列接口（列表、创建、更新、删除、详情）
  - [x] 材料与文档绑定关系透传到 NDR Document
- [x] 后端：节点与资料关系绑定（多对多关联）
  - [x] 基于 NDR Relationships API 实现多对多绑定
  - [x] `/api/v1/relationships` 接口（GET/POST/DELETE）支持查询、绑定、解绑
  - [x] 批量绑定接口：一次将材料绑定到多个节点
  - [x] 双向查询：根据节点查材料、根据材料查节点
- [x] 后端：文档版本管理（透传 NDR 版本接口）
  - [x] 版本历史列表：`GET /api/v1/documents/{id}/versions`（分页支持）
  - [x] 获取特定版本：`GET /api/v1/documents/{id}/versions/{version_number}`
  - [x] 版本对比：`GET /api/v1/documents/{id}/versions/{from}/diff?to={to}`
  - [x] 版本回滚：`POST /api/v1/documents/{id}/versions/{version_number}/restore`
  - [x] 完整的 ndrclient、service、handler 层封装
- [x] 前端：资料管理界面
  - [x] Materials API 客户端（materials.ts）
  - [x] Relationships API 客户端（relationships.ts）
  - [x] 资料列表组件 MaterialList（支持不同资料类型、筛选、分页）
  - [x] 资料创建/编辑表单 MaterialForm（题目类型动态表单）
  - [x] 资料预览组件 MaterialPreview（完整资料详情展示）
  - [x] MaterialPanel 容器组件（统一管理资料界面）
  - [x] 集成到 App.tsx（使用 Tabs 在文档与资料之间切换）
- [ ] 节点-资料关系管理界面（待开发）
- [ ] 版本历史展示与对比界面（待开发）
- [ ] 版本回滚操作界面（待开发）

## 迭代二总结 ✅ 核心功能已完成
后端资料管理系统、节点-资料关系绑定、文档版本管理已全部实现并通过测试。前端基础资料管理界面已集成到主应用，支持材料的创建、编辑、预览和列表展示。

## 正在进行
- [ ] 节点-资料关系管理 UI
- [ ] 版本管理 UI

## 待办事项
- [ ] 整理 NDR 接口调用示例与错误约定，完善后端集成说明。
- [ ] 设计节点排序字段使用方案（`metadata.order`）并在实现前确认。
- [ ] 准备基础自动化测试方案（Go `httptest` + 前端组件测试）供后续落地。
  - [x] 后端分类 API `httptest` 覆盖主要操作与异常请求校验（含恢复、彻底删除），内存 fake NDR 提供可扩展测试基座。
  - [x] 前端测试框架配置完成（vitest + @testing-library/react）。
  - [ ] 继续补齐更多 API 边界用例及前端组件测试。
- [ ] 迭代三：增强功能
  - [ ] 搜索与过滤
  - [ ] 批量导入导出
  - [ ] 权限与审计
  - [ ] 缓存优化（Redis 接入）
*** End Patch
