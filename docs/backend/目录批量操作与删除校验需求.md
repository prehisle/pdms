# 目录批量操作与删除校验需求说明

为提升目录管理体验，需要在后续迭代中补齐右键菜单的复制/剪切/粘贴能力，以及批量操作时的安全校验。以下拆分为两个独立任务，可并行规划。

---

## 1. 目录树右键菜单（复制 / 剪切 / 粘贴）

### 目标
- 支持在目录树中多选同一父节点下的节点后，通过右键菜单执行复制、剪切、粘贴。
- 粘贴时可以选择目标位置（作为子节点、或插入到同级节点之前/之后）。
- 结合现有 `reposition` 接口，实现一次请求完成移动+排序；复制时需要新增批量创建逻辑。

### 前端需求
1. **多选逻辑**：延续当前无勾选的多选高亮模式，仅允许同父节点批量选中；右键菜单基于当前选集动态启用/禁用选项。
2. **剪贴板状态**：
   - `mode`: `copy` 或 `cut`。
   - `nodes`: 被选中的节点（含子树结构）缓存于剪贴板。
   - 剪切模式在 UI 中标注（如半透明/图标），粘贴成功后自动清理。
3. **涉及源码目录**
   - `frontend/src/App.tsx`: Tree 多选状态管理、右键菜单弹出、剪贴板逻辑与操作入口。
   - `frontend/src/api/categories.ts`: 扩展批量复制/剪切/粘贴相关 API 封装。
   - `frontend/src/components/*`（若拆分组件）：菜单渲染、确认弹窗等。
3. **右键菜单项**（示例）：
   - `复制`: 复制选中节点子树。
   - `剪切`: 复制后标记为剪切状态。
   - `粘贴`:
     - 若在父节点/根区域触发，粘贴为该节点的子节点。
     - 若在某同级节点上触发，可选择“置于此节点前/后”。
   - `取消剪切`: 清空剪贴板。
4. **交互流程**：
   - 复制/剪切 -> 更新剪贴板 -> 在目标位置右键粘贴 -> 成功后刷新树（保留展开状态）。
   - 粘贴前弹出确认框（显示目标位置/数量）。
   - 粘贴失败时保留剪贴板，展示具体错误（如命名冲突）。

### 后端需求
1. **批量复制**：
   - 需要提供批量创建接口（例如 `POST /api/v1/categories/bulk/copy`），支持多节点子树复制。
   - 创建时沿用原有排序与层级，支持插入到指定父节点＋参考节点前后。
2. **批量剪切**：
   - 剪切粘贴成功后需要删除原节点（软删），可沿用已存在的单节点删除或新增批量删除接口。
3. **请求校验**：
   - 粘贴目标必须存在且用户有权限；若存在同名节点需返回 409，前端提示重命名。
   - 剪切后若粘贴失败，应保持原节点不变，避免数据丢失。
4. **日志与测试**：
   - 后端新增单元测试/集成测试覆盖多节点复制/剪切场景。
   - 记录复制/剪切操作日志，便于排查问题。
5. **涉及源码目录**
   - `backend/internal/api/handler.go`: 新增批量复制/剪切相关路由与处理逻辑。
   - `backend/internal/service/category.go`: 具体业务实现、参数校验。
   - `backend/internal/ndrclient/*`: 如需扩展底层 NDR 接口调用。
   - `docs/backend/openapi.json`: 更新开放接口文档。
   - `backend/internal/api/handler_test.go`、`backend/internal/service/category_test.go`: 增加单元测试。

---

## 2. 批量操作与彻底删除前的关联校验

### 目标
- 在执行批量删除 / 批量彻底删除前，对节点关联的文档、题目等资源进行校验，防止误删。
- 批量操作界面提供状态提示，支持多选时的确认弹窗。

### 前端需求
1. **批量操作入口**：
   - 在目录树右键菜单中扩展“批量删除”、“批量彻底删除”，仅在全选项合法时启用。
   - 显示待删除节点的数量、首个节点路径等信息。
2. **删除前提示**：
   - 调用后端关联校验接口获取依赖数据（如绑定文档个数、是否存在子节点）。
   - 若存在关联，则弹窗列出摘要（或下载详细列表），要求用户确认或放弃。
3. **操作结果反馈**：
   - 删除成功后刷新树与回收站；提供“查看详情”链接或操作日志。
   - 若部分节点删除失败，保持剪贴板/选中状态，并逐条提示失败原因。
4. **涉及源码目录**
   - `frontend/src/App.tsx`: 批量操作入口、确认弹窗、校验信息展示。
   - `frontend/src/api/categories.ts`: 批量校验、批量删除/彻底删除 API 封装。

### 后端需求
1. **关联校验接口**：
   - 新增 `POST /api/v1/categories/bulk/check` 或类似接口，入参为节点 ID 列表，返回：
     - 是否可软删/彻底删。
     - 关联资源概要（文档数量、题目数量等）。
     - 需要用户确认的提示信息。
   - 可复用现有 NDR 能力或业务库，必要时增加缓存。
2. **批量删除 / 批量彻底删除**：
   - 在执行任何删除前先调用校验接口，并在服务端再次检查，防止绕过。
   - 对存在子节点的节点禁止彻底删除，给出明确错误。
3. **日志与审计**：
   - 删除请求需记录操作人、节点列表、校验结果与最终动作，方便审计与回溯。
4. **测试**：
   - 补充单元测试覆盖：无关联、存在关联、部分失败等场景。
   - 可选地增加集成测试验证多节点事务行为。
5. **涉及源码目录**
   - `backend/internal/api/handler.go`: 批量校验/删除路由及响应。
   - `backend/internal/service/category.go`: 校验逻辑、批量删除实现。
   - `backend/internal/api/handler_test.go`、`backend/internal/service/category_test.go`: 相关测试用例。
   - 如需校验文档/题目关联，可能涉及 `backend/internal/document/service.go`（或未来新增模块）。

---

## 路线建议（DMS 自研实现）
由于 NDR 保持通用 CRUD 能力，不提供批量复制/剪切及删除前校验接口，DMS 需自建编排层。推荐分阶段落地：

### 第一阶段：DMS 剪贴板编排
- **后端**
  1. `service/bulk_ops`：实现“抓取子树 → 逐节点创建 → 统一 reorder”的批量复制能力；剪切沿用复制 + 原地删除，并提供失败补偿策略。（`/api/v1/categories/bulk/copy` 已上线，后续补剪切）
  2. 新增 `POST /api/v1/categories/bulk/copy`、`/bulk/move` 等内部接口，记录操作人/任务 ID，便于重试与审计。
  3. 扩展单元测试覆盖复制/剪切、回滚分支以及 fake NDR 的组合调用。
- **前端**
  1. 多选/右键菜单/剪贴板状态管理。
  2. 粘贴位置确认弹窗、执行结果提示、失败重试入口。
- **联调**：验证复制/剪切在多节点、多层级场景下的正确性，确保排序一致。

### 第二阶段：批量删除前校验
- **后端**
  1. 新增 `POST /api/v1/categories/bulk/check`，聚合 NDR `/nodes/{id}/subtree-documents` 及 DMS 内部题目数据，返回删除风险摘要。
  2. 扩展现有批量软删/彻底删接口，在执行前强制校验并记录日志。
  3. 单元测试覆盖“无关联”“存在文档”“存在子节点”及部分失败场景。
- **前端**
  1. 删除入口弹窗展示校验结果、风险提示、二次确认。
  2. 删除完成后刷新目录树/回收站，并突出失败明细。

### 第三阶段（可选）：批量任务治理
- 落地批量操作任务表，支持后台重跑、超时告警与操作日志审计。
- 引入消息队列或工作流调度，提升大规模复制/删除的稳定性。
