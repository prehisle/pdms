# 题库管理系统项目规划与方案

## 一、背景与目标
- 目标：构建一套支持题目内容管理、分类组织与版本追踪的题库管理系统，后端使用 Go 实现业务 API，存储与结构化数据依托现有的 NDR（节点 Node、文档 Document、关系 Relationship）服务。
- 题型范围：首批覆盖单选题、多选题、单题多空单选题，并为默写题等扩展题型预留模型，确保题库可持续扩展。
- 资料类型：除题目外，还需管理 HTML 形式的概览/资料页，与题目统一纳入目录体系管理与编辑。
- 优先事项：先交付节点（题库目录）管理能力，实现节点的增删改查、拖拽调整层级顺序等核心操作；随后扩展题目内容管理与节点-题目绑定能力。
- 既有资产：NDR 服务已提供标准 REST 接口（详见 `docs/backend/openapi.json`），包含节点、文档、关系以及文档版本能力，可直接复用。

## 二、现状约束与设计假设
- 身份与鉴权：NDR 服务要求 `x-api-key`、`x-user-id`、`x-request-id` 等头部。题库后端需统一封装这些头部的生成与传递。
- 数据模型：
  - 节点 Node：以 `path`/`parent_path` 维护结构，接口返回 `parent_id` 与 `position` 字段，可直接用于构建树及同级排序。
    - 创建根目录时使用虚拟根路径（`/`），前端仅提供目录名；后端根据名称生成唯一 `slug`、`position` 由 NDR 生成。
  - 文档 Document：包含 `title`、`content`、`metadata`，可承载题目正文、解析、标签等信息。
  - 关系 Relationship：可表达节点与文档的绑定关系。
- 题型建模：使用文档 `metadata` 描述题型（`question_type`）、选项、答案结构，`content` 存放题干文本与多空结构；需约定字段必填校验规则，保证前后端一致。
- 资料类型建模：通过 `metadata.resource_type` 区分题目（`question`）、概览页（`overview`）、默写题（`dictation` 等），并增加 `metadata.content_format`（如 `rich_text`、`html`）与多目录关联能力（同一文档可绑定多个节点）。
- 假设：题目与目录之间的一对多关系通过 Relationship 表达；目录排序依赖 NDR 提供的 `position` 字段及批量重排接口，业务层确保调用顺序正确。

## 三、总体架构设计
- **前端（React + Ant Design）**：实现题库管理界面，重点是目录树的可视化与拖拽操作、题目列表、题目编辑/预览弹窗。
- **题库后端（Go）**：
  - 对外暴露领域友好的 REST API，例如 `/api/materials`, `/api/categories` 等。
  - 内部通过 NDR SDK/Client 调度节点、文档、关系接口，并负责数据拼装、权限校验；初期不引入缓存，但在 `service` 层预留缓存装饰器扩展点。
- **NDR 服务**：现有能力不改造，题库后端作为消费方。
- **辅助组件**：日志、链路追踪（透传 `x-request-id`）、配置中心（保存 NDR 地址/API Key）；缓存层（如 Redis）暂缓实施，但通过接口抽象与依赖注入保留后续接入能力。

## 四、功能规划（按优先级）
1. **节点管理（MVP）**
   - 节点树展示：分页/按需请求 `/api/v1/nodes`、`/api/v1/nodes/{id}/children`。
   - 根目录/子目录创建：允许用户创建任意层级节点（根目录或子目录），创建时仅需输入目录名，其余 `slug`、`parent_path` 由后端算出。
   - 节点增删改：映射到 NDR `POST/PUT/DELETE /api/v1/nodes`，支持重命名、软删除、恢复。
   - 节点拖拽：前端拖拽后调用题库后端的 `PATCH /categories/{id}/move`，由后端转为 NDR `PUT` 请求更新 `parent_path`、`slug`。
   - 排序维护：拖拽同级节点后调用 `/api/v1/nodes/reorder` 批量提交新顺序，依托 NDR 内置 `position` 字段记录。
2. **题目与资料管理**
   - 资料 CRUD：映射 NDR 文档接口，创建时指定 `resource_type`（题目、概览页、默写题等）与题型，`metadata` 记录题型、选项、答案、难度、标签、解析、HTML 模板引用等；`content` 存题干、空位描述或 HTML 正文。
   - 预览与修改：后端提供统一资料详情接口，前端以弹窗或侧滑形式预览，按类型加载题目渲染器、HTML 预览器或默写题编辑器，支持就地编辑并回写 NDR。
   - 版本管理：题库后端透传 NDR `/api/v1/documents/{id}/versions` 能力，对外提供 `/materials/{id}/versions` 接口支持版本追踪与回滚，覆盖题目与概览页。
   - 题型扩展：以策略模式管理不同题型/资料类型的数据结构与校验规则，新增题型时仅需配置 `metadata` 模式与前端渲染器。
3. **节点与资料关系**
   - 绑定/解绑：调用 `/api/v1/relationships`，支撑同一资料关联到一个或多个目录节点。
   - 查询节点下资料：组合 `List Relationships` 与 `Get Document`，输出类型过滤、排序与分页列表，点击列表项可进入详情编辑。
4. **辅助能力**
   - 搜索与过滤、批量导入导出、操作日志、权限分级（后续迭代）。

## 五、后端详细方案（Go）
- **技术栈建议**：Go 1.22+、Gin/Fiber 作为 HTTP 框架、Golang 官方 `net/http` 客户端封装 NDR、Viper 读取配置、Zap/Logrus 记录日志、Gorm 可选（若需要业务库）。
- **模块划分**：
  - `api`：HTTP Handler，提供题库业务语义的接口。
  - `service`：封装节点、题目、资料业务逻辑（根/子目录创建、拖拽、排序、批量更新、资源类型策略/校验）。
  - `ndrclient`：对接 NDR API，统一处理认证、重试、错误转换。
  - `repository`：可选缓存/数据库访问（如维护节点排序、权限信息），通过接口定义保证后续可无痛引入缓存实现。
  - `cache`（占位）：定义通用缓存接口、序列化策略，初期提供 no-op 实现，后续可替换为 Redis 等。
  - `middleware`：请求日志、请求 ID 注入、错误统一处理。
- **核心接口草案**：
  - `GET /categories/tree`：加载完整目录树或指定深度子树，支持 `include_deleted` 筛选。
  - `GET /categories/{id}`：查询单节点详情。
  - `POST /categories`、`PATCH /categories/{id}`、`DELETE /categories/{id}`、`POST /categories/{id}/restore`：创建、更新、软删、恢复目录节点；`POST` 入参包含目录名及可选 `parent_id`。
  - `PATCH /categories/{id}/move`：处理跨层级拖拽，转换为 NDR `PUT /api/v1/nodes/{id}` 更新 `parent_path`。
  - `POST /categories/reorder`：封装 NDR `POST /api/v1/nodes/reorder`，批量提交同级目录的排序结果。
  - `GET /categories/{id}/materials`：聚合节点下资料，支持按类型筛选、分页、搜索。
  - `POST /materials`、`PUT /materials/{id}`、`GET /materials/{id}`、`DELETE /materials/{id}`：统一管理题目、概览页、默写题；必要时提供 `PATCH /materials/{id}/versions/{version}/restore`。
  - `POST /materials/{id}/relationships`、`DELETE /materials/{id}/relationships`：维护资料与目录节点的多对多关联，支持批量绑定/解绑，并映射到 NDR `/api/v1/relationships`。
- **错误处理与幂等**：对接 NDR 失败时返回明确错误码；拖拽操作需保证幂等（重复请求不产生副作用）。
- **测试策略**：使用 `httptest` 与 fake NDR server 进行集成测试；为拖拽排序编写边界用例。

## 六、NDR 集成策略
- **请求封装**：集中管理 API Key、User ID、Request ID；提供中间件自动生成 `x-request-id`，并允许前端透传以实现链路追踪。
  - 后端接口向 NDR 转发请求时，同时支持从请求头获取 `x-api-key`、`x-user-id`、`x-request-id`，若未显式提供则回退到后端配置。
- **节点树模型**：
  - `NodeCreate` / `NodeUpdate` 需提供 `name`、`slug`、`parent_path`。拖拽移动目录时，通过更新 `parent_path` 变更层级，返回结果包含新的 `parent_id`。
  - `NodeOut` 返回 `parent_id` 与 `position`，并提供 `POST /api/v1/nodes/reorder` 批量调整 `ordered_ids`，可直接构建树并维护同级排序。
- **文档模型**：
  - `DocumentCreate` 支持 `metadata`，建议约定结构，例如：
    ```json
    {
      "resource_type": "question",
      "question_type": "single_choice",
      "difficulty": 3,
      "tags": ["math", "algebra"],
      "options": [
        {"key": "A", "text": "option A"},
        {"key": "B", "text": "option B"},
        {"key": "C", "text": "option C"}
      ],
      "blanks": [],
      "answer": ["C"],
      "analysis": "...",
      "content_format": "rich_text"
    }
    ```
  - 内容大字段存于 `content`，可用 Markdown/JSON。
  - 单题多空单选题需在 `blanks` 中标识空位数量与提示，并在 `answer` 中给出每个空的选项 key，前后端共同校验数量匹配。
  - 概览页等 HTML 资料将 `resource_type` 设为 `overview`、`content_format` 设为 `html`，`content` 保存 HTML 片段或引用模版 ID。
  - 默写题以 `resource_type=dictation`、`content_format=rich_text`（或 `audio` 扩展）表示，`metadata` 中定义段落拆分、提示词及评分规则，便于前端按字段渲染。
- **关系处理**：批量关系维护时，优先使用 `POST /api/v1/relationships` 与 `DELETE` 的组合，避免多次节点更新；同一文档允许绑定多个节点，需在后端追加去重与权限校验。

## 七、前端实现规划（Ant Design）
- **技术栈**：Vite + React 18、TypeScript、Ant Design、React Query/SWR 管理数据请求、React Router 控制页面。
- **首页布局**：左侧题库目录树（`Tree` 组件，启用 `draggable`），右侧展示选中节点下题目列表与详情。
- **资料列表区**：节点点击后请求 `GET /categories/{id}/materials`（或按资源类型筛选的接口），以 `Tabs` 或 `Segmented` 切换题目、概览页、默写题列表，列表项提供预览、编辑、关联目录等操作入口。
- **目录创建交互**：提供“新建根目录”“新建子目录”入口，使用 Antd `Modal/Form` 仅收集目录名称，提交后刷新对应节点（根节点在虚拟 `root` 下渲染）。
- **拖拽交互**：
  - 前端监听 `onDrop`，生成目标父节点 ID 与排序信息。
  - 调用后端 `PATCH /categories/{id}/move`，成功后乐观更新本地树；失败时回滚并提示。
  - 增加拖拽限制（禁止拖入自身子树、禁止跨越特定层级等）由前端初检，后端兜底校验。
- **资料管理界面**：
  - 列表：使用 `Table` 支持筛选、分页。
  - 编辑：Antd `Form`/`Modal` 结合富文本或自定义题型配置，依据题型动态渲染选项、空位配置；概览页提供 HTML 富文本/代码编辑器；默写题提供段落拆分、答案校验配置。
  - 预览：利用 `Drawer` 或 `Modal` 展示题干、选项、答案与解析，支持从预览直接跳转到编辑模式。
  - 版本视图：调用 `GET /materials/{id}/versions`，以时间线方式展示差异。
  - 关联管理：在资料编辑弹窗中提供目录选择器（树形多选），提交后同步调用绑定/解绑接口。
- **状态管理**：`React Query` 缓存节点数据，支持懒加载与失效重刷；拖拽、批量操作使用 mutation。

## 八、迭代计划（建议）
0. **迭代零：架构骨架（已完成）**
   - 搭建 Go 服务基础目录结构（`cmd/`, `internal/api`, `internal/service`, `internal/ndrclient`, `internal/cache` 等）与通用中间件、配置加载、路由框架，提交 `58f4061`。
   - 前端创建 React/Antd 项目骨架，完成路由、状态管理、API 封装的基础目录布局，并提供 hello world 页面。
   - 补充 `air` 自动重载配置和请求日志中间件，简化后续开发体验。
1. **迭代一：目录 MVP（进行中）**
   - 完成 Go 后端基础框架、NDR Client、节点 CRUD、拖拽移动接口。
   - 前端完成目录树展示、节点 CRUD、拖拽操作闭环。
2. **迭代二：资料管理扩展**
   - 上线资料 CRUD（题目、概览页、默写题等）、节点-资料绑定、资料列表/详情页面。
   - 打通多目录关联、资料版本回溯、HTML 编辑与预览能力。
3. **迭代三：增强功能**
   - 搜索与筛选、批量导入导出、权限与审计、缓存优化、性能压测。

## 九、风险与应对
- 节点排序需依赖前端拖拽结果的正确提交，需设计并发隔离与幂等策略，避免覆盖他人调整。
- 大规模树结构性能：采取懒加载、分页、缓存策略，必要时增加后端聚合接口。
- 文档内容结构化需求：提前定义元数据规范，避免后期兼容难度。
- 依赖 NDR 可用性：提供重试与降级策略，并对关键操作记录补偿队列。
- HTML 编辑安全与预览一致性：引入 XSS 过滤和渲染沙箱，避免概览页内容影响管理端。
- 暂未接入缓存：关注高频读取接口的性能监控，为后续接入 Redis 等缓存组件预留指标与开关。
