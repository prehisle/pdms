# 文档引用功能使用说明

## 功能概述

文档引用功能允许你在编辑文档时，为当前文档添加对其他文档的引用。这对于建立文档之间的关联关系非常有用，比如：
- 标记前置知识文档
- 链接相关内容
- 引用参考资料
- 关联示例文档

## 使用入口

### 在文档编辑器中使用

1. **打开文档编辑器**
   - 点击文档列表中的任意文档进入编辑模式
   - 或者在文档详情页点击"编辑"按钮

2. **找到引用管理区域**
   - 在编辑器左侧面板中
   - 位于"额外元数据"区域的下方
   - 显示为 "🔗 引用的文档 (N)" 标题

3. **引用管理功能位置**
   ```
   ┌─────────────────────────────────┐
   │  文档编辑器                      │
   ├─────────────────────────────────┤
   │  标题、类型、标签               │
   ├─────────────────────────────────┤
   │  额外元数据编辑区               │
   ├─────────────────────────────────┤
   │  🔗 引用的文档 (N)  [添加引用]  │  ← 引用管理区域
   │  ├─ 文档1                       │
   │  ├─ 文档2                       │
   │  └─ ...                         │
   ├─────────────────────────────────┤
   │  Monaco 代码编辑器              │
   └─────────────────────────────────┘
   ```

## 功能说明

### 1. 添加引用

**步骤：**
1. 点击右上角的"添加引用"按钮
2. 在弹出的树形选择器中浏览分类和文档
3. 点击分类节点可展开查看该分类下的文档
4. 点击要引用的文档即可添加

**特性：**
- ✅ 树形结构展示，方便查找
- ✅ 按需加载文档列表
- ✅ 自动过滤当前编辑的文档（防止自引用）
- ✅ 自动过滤已添加的引用（防止重复）

### 2. 查看引用列表

引用列表会显示：
- 📄 被引用文档的标题
- 📅 添加引用的时间
- 🔗 点击标题可在新标签页打开被引用文档

### 3. 删除引用

**步骤：**
1. 在引用列表中找到要删除的引用
2. 点击右侧的删除按钮（红色垃圾桶图标）
3. 确认删除操作

**注意：** 删除引用只会移除引用关系，不会删除被引用的文档本身。

## 数据存储

引用关系存储在文档的 `metadata.references` 字段中，格式如下：

```json
{
  "metadata": {
    "references": [
      {
        "document_id": 123,
        "title": "被引用文档的标题",
        "added_at": "2025-10-29T12:00:00Z"
      }
    ]
  }
}
```

## 权限说明

- **管理员和课程管理员**：可以添加和删除引用
- **校对员**：��能查看引用，不能编辑

## 使用场景示例

### 场景1：知识点文档的前置知识

当编辑一个高级知识点文档时：
1. 添加对基础知识点文档的引用
2. 标记为"前置知识"
3. 学习者可以先查看基础文档再学习高级内容

### 场景2：练习题引用解答

当编辑练习题文档时：
1. 添加对详细解答文档的引用
2. 学习者可以先尝试练习，再查看解答

### 场景3：案例分析引用理论

当编辑案例分析文档时：
1. 添加对相关理论知识的引用
2. 将理论与实践连接起来

## 注意事项

1. **新建文档时不可用**
   - 引用功能只在编辑现有文档时可用
   - 新建文档需要先保存后才能添加引用

2. **自动保存**
   - 添加或删除引用会立即保存到服务器
   - 无需手动保存文档

3. **引用方向**
   - 当前实现的是单向引用
   - A 引用 B 不代表 B 引用 A
   - 如需双向关联，需要分别在两个文档中添加引用

4. **性能考虑**
   - 树形选择器按需加载文档，不会一次性加载所有文档
   - 适合大量文档的场景

## 常见问题

**Q: 为什么我看不到"添加引用"按钮？**
A: ���能的原因：
- 你正在新建文档（需要先保存）
- 你的角色是校对员（只有查看权限）

**Q: 如何查看哪些文档引用了当前文档？**
A: 目前前端界面暂未实现"被引用于"的反向查询，但后端已提供 API：
`GET /api/v1/documents/{id}/referencing`

**Q: 可以引用已删除的文档吗？**
A: 不可以。只能引用正常状态的文档。

**Q: 删除被引用的文档会怎样？**
A: 引用关系会保留，但被引用文档的 ID 会指向一个不存在的文档。建议在删除文档前检查是否被其他文档引用。

## 技术细节

- **后端 API**：
  - `POST /api/v1/documents/{id}/references` - 添加引用
  - `DELETE /api/v1/documents/{id}/references/{refId}` - 删除引用
  - `GET /api/v1/documents/{id}/referencing` - 反向查询

- **前端组件**：
  - `DocumentReferenceManager` - 引用管理器（主组件）
  - `DocumentTreeSelector` - 树形文档选择器
  - 已集成到 `DocumentEditor` 组件中

## 未来改进方向

- [ ] 在文档详情页显示引用关系
- [ ] 显示"被引用于"反向关系
- [ ] 引用关系可视化图谱
- [ ] 智能推荐相关文档
- [ ] 批量管理���用
- [ ] 引用类型分类（前置知识、相关内容、参考资料等）

---

如有问题或建议，请联系开发团队。
